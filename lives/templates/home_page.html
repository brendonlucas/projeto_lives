{% extends 'base.html' %}
{% block 'content' %}
<section class="shadow-card theme-select" style=" padding:20px;margin:10px; border-radius:10px">
    <div class="card" style="padding:10px 10px 0px 10px; margin:10px">
        <div class="d-flex">
            <div class="mr-auto p-2 align-self-center"><h3> {{ fac.nome }}</h3></div>

            <div class="form-group d-flex p-2">
                <label class="form-label p-2" for="facSelect">Fac:</label>
                <select class="form-control" id="facSelect" style="max-width:150px">
                    <option selected disabled>Selecione a fac</option>
                    {% for fac in facs %}
                    <a href="www.google.com">
                        <option value="{{ fac.pk }}"> {{ fac.nome }}</option>
                    </a>
                    {% endfor %}

                </select>
            </div>


            <div class="dropdown p-2">
                <button class="btn btn-md btn-primary btn-addon m-b-10 m-l-5 dropdown-toggle" type="button"
                        data-toggle="dropdown" aria-expanded="false"><i class="ti-plus"></i> Adicionar
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" data-toggle="modal"
                       data-target="#MOdalAdicionarVeiculo">FAC</a>
                    <a class="dropdown-item" href="#" data-toggle="modal"
                       data-target="#MOdalAdicionarCanal">Streamer</a>

                </div>
            </div>
            <div class="p-2">
<!--                <form method="post" action="#" class="input-group"-->
<!--                      style="max-width: 200px; margin-left:auto; float:right ">-->
<!--                    <input type="hidden" name="csrfmiddlewaretoken"-->
<!--                           value="dVP1lUMwIuWRiDiYoqjV45BnrByr4N4i812nz3CNUIfY45Z3OeBluPmwB5bn77bn">-->
<!--                    <input type="search" class="form-control rounded" placeholder="Buscar" aria-label="Search"-->
<!--                           aria-describedby="search-addon" id="myFilter" onkeyup="myFunction()">-->
<!--                    <button type="submit" class="btn btn-primary" ><i class="ti-search"></i></button>-->
<!--                </form>-->
                <button type="submit" class="btn btn-primary" onclick="ordenarTabela()"><i class="ti-search"></i> ordenar</button>
            </div>
        </div>

        <div class="modal fade" data-backdrop="static" id="MOdalAdicionarVeiculo" tabindex="-1" role="dialog"
             aria-labelledby="ModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="veiculoModalCenterTitle">Adicionar FAC</h5>
                    </div>
                    <form method="post" action="{% url 'add_fac' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-body d-flex justify-content">
                            <div style="margin:10px; padding:5px; width:100%; max-height:400px; overflow-y: auto;">
                                <div class="form-group">
                                    <label>Nome da FAC</label>
                                    <input type="text" class="form-control" placeholder="" name="name_fac">
                                </div>
                                <div class="form-group">
                                    <label>Descrição</label>
                                    <input type="text" class="form-control" placeholder="" name="desc_fac">
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <div class="mr-auto">
                                <i class="mr-auto"> - Preencha os campos adequadamente </i> <br>
                            </div>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" data-backdrop="static" id="MOdalAdicionarCanal" tabindex="-1" role="dialog"
             aria-labelledby="ModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="canelModalCenterTitle">Adicionar FAC</h5>
                    </div>
                    <form method="post" action="{% url 'add_streamer' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-body d-flex justify-content">

                            <div style="margin:10px; padding:5px; width:100%; max-height:400px; overflow-y: auto;">
                                <div class="form-group">
                                    <label>Fac:</label>
                                    <select class="form-control" name="selectFacPlayer" required>
                                        <option selected disabled>Selecione a fac</option>
                                        {% for fac in facs %}
                                        <option value="{{ fac.pk }}"> {{ fac.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Nome do canal</label>
                                    <input type="text" class="form-control" placeholder="" name="name_canal">
                                </div>
                                <div class="form-group">
                                    <label>Nome do canal</label>
                                    <input type="text" class="form-control" placeholder="" name="name_nick">
                                </div>
                                <div class="form-group">
                                    <label>Link Youtube</label>
                                    <input type="text" class="form-control" placeholder="" name="name_yt">
                                </div>
                                <div class="form-group">
                                    <label>Link Kick</label>
                                    <input type="text" class="form-control" placeholder="" name="name_kick">
                                </div>
                                <div class="form-group">
                                    <label>Link Twitch</label>
                                    <input type="text" class="form-control" placeholder="" name="name_tw">
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <div class="mr-auto">
                                <i class="mr-auto"> - Preencha os campos adequadamente </i> <br>
                            </div>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="card" style="padding:10px 10px 10px 10px; margin:10px">
        <div class="card" style="" id="card_tabela">
            <table class="table theme-select" id="tabela_1">
                <thead class="thead-dark ">
                <tr>
                    <th scope="col">N°</th>
                    <th scope="col">Nome do canal</th>
                    <th scope="col">Nick em game</th>
                    <th scope="col">fac</th>
                    <th scope="col">Canais</th>
                    <th scope="col">Opçoes</th>

                </tr>
                </thead>
                <tbody>
                {% for canal in canais %}
                <tr>
                    <th scope="row">1</th>
                    <td>{{ canal.nome }}</td>
                    <td>{{ canal.nick_player }}</td>
                    <td>{{ canal.fac_player.nome }}</td>
                    <td>
                        <a class="btn btn-outline-danger btn-sm" href="{{ canal.link_yt }}" target="_blank"><img
                                src="https://img.icons8.com/?size=100&id=fN3hHbnVavBm&format=png&color=000000"
                                width="25px"
                                height="25px">
                            <b>OFF</b>
                        </a>
                        <a class="btn btn-outline-secondary btn-sm" href="{{ canal.link_tw }}" target="_blank"><img
                                src="https://img.icons8.com/?size=100&id=18103&format=png&color=000000" width="25px"
                                height="25px">
                            <b id="statusTag{{ canal.nome }}">OFF</b>
                        </a>
                        <script>
                            async function checkTwitchStatus() {
                                const channel = "{{ canal.nome }}";
                                const url = `https://decapi.me/twitch/uptime/${channel}`;
                                try {
                                    const response = await fetch(url);
                                    const text = await response.text();
                                    const statusTag = document.getElementById("statusTag{{ canal.nome }}");
                                    if (text.toLowerCase().includes("offline")) {
                                        statusTag.textContent = "OFF";
                                        console.log(text);
                                    }
                                    else {
                                        statusTag.textContent = "LIVE";
                                        console.log(text);
                                    }
                                } catch (error) {
                                    console.error("Erro ao consultar API decapi.me", error);
                                }
                            }

                            checkTwitchStatus();
                        </script>


                        <a class="btn btn-outline-success btn-sm" href="{{ canal.link_kick }}" target="_blank"><img
                                src="https://cdn.brandfetch.io/id3gkQXO6j/w/400/h/400/theme/dark/icon.jpeg?c=1bxid64Mup7aczewSAYMX&t=1752548681236"
                                width="25px"
                                height="25px">
                            <b>OFF</b>
                        </a>
                    </td>
                    <td>
                        <a class="btn btn-sm" href="{% url 'del_canal' pk=canal.id %}"><img
                                src="https://img.icons8.com/?size=100&id=1941&format=png&color=000000"
                                width="25px"
                                height="25px">
                        </a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</section>

<script>
    document.getElementById('facSelect').addEventListener('change', function() {
        const pk = this.value;
        if (pk) {
            const url = "{% url 'show_live_fac' 0 %}".replace('0', pk);
            window.location.href = url;
        }
    });
</script>

<script>
function ordenarTabela() {
    const tabela = document.getElementById("tabela_1");
    const tbody = tabela.querySelector("tbody");
    const linhas = Array.from(tbody.querySelectorAll("tr"));

    const processadas = [];

    linhas.forEach((linha, index) => {
        const colunaCanais = linha.querySelector("td:nth-child(5)");
        const segundoLink = colunaCanais.querySelectorAll("a")[1];
        const status = segundoLink.querySelector("b").textContent.trim();

        if (status === "LIVE") {
            linha.style.backgroundColor = "#b9ffb9";
            linha.dataset.online = "1";
        } else {
            linha.style.backgroundColor = "";
            linha.dataset.online = "0";
        }

        processadas.push(linha.dataset.online);
    });

    linhas.sort((a, b) => b.dataset.online - a.dataset.online);

    linhas.forEach(linha => tbody.appendChild(linha));

}
</script>



<!--<script>-->
<!--function ordenarTabela() {-->
<!--    const tabela = document.querySelector("#tabela_1 tbody");-->
<!--    const linhas = Array.from(tabela.querySelectorAll("tr"));-->

<!--    alert("Total de linhas encontradas: " + linhas.length);-->

<!--    linhas.forEach((linha, i) => {-->
<!--        const colunaCanais = linha.querySelectorAll("td")[3];-->
<!--        const segundoA = colunaCanais.querySelectorAll("a")[1];-->
<!--        const textoStatus = segundoA.querySelector("b").textContent.trim();-->

<!--        alert("Linha " + (i+1) + " → Status encontrado: " + textoStatus);-->

<!--        linha.dataset.ordem = textoStatus === "LIVE" ? 1 : 0;-->
<!--    });-->

<!--    linhas.sort((a, b) => b.dataset.ordem - a.dataset.ordem);-->

<!--    linhas.forEach(l => tabela.appendChild(l));-->

<!--    alert("Tabela reorganizada!");-->
<!--}-->
<!--</script>-->



<!--<script>-->
<!--function ordenarPorLive() {-->
<!--    const tabela = document.getElementById("tabela_1");-->
<!--    const tbody = tabela.querySelector("tbody");-->

<!--    let linhas = Array.from(tbody.querySelectorAll("tr"));-->

<!--    linhas.sort((linhaA, linhaB) => {-->
<!--        const aLive = temLiveNaSegundaA(linhaA) ? 1 : 0;-->
<!--        const bLive = temLiveNaSegundaA(linhaB) ? 1 : 0;-->
<!--        return bLive - aLive;-->
<!--    });-->
<!--    linhas.forEach(linha => tbody.appendChild(linha));-->
<!--}-->

<!--function temLiveNaSegundaA(linha) {-->
<!--    const colunaCanais = linha.querySelectorAll("td")[3 + 1];-->
<!--    if (!colunaCanais) return false;-->
<!--    const links = colunaCanais.querySelectorAll("a");-->
<!--    if (links.length < 2) return false;-->
<!--    const segundaA = links[1];-->
<!--    const bTag = segundaA.querySelector("b");-->
<!--    if (!bTag) return false;-->
<!--    return bTag.textContent.trim().toUpperCase() === "LIVE";-->
<!--}-->
<!--</script>-->



{% endblock %}